<!DOCTYPE html>
<html lang="en">

<head>
    <!--Styling-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- JavaScript -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb"
        crossorigin="anonymous"></script>
    <!--Vue Stuff-->
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue-resource@1.3.4"></script>

    <title>DVR Viewer</title>
</head>

<body style="background-color:rgba(238, 238, 238, 0.767)">
    <div id="app">
        <ul id="dropdown1" class="dropdown-content">
            <li v-for="item in dvrOptions">
                <a v-on:click="setCurrentDvr(item)">{{ item.key }}</a>
            </li>
        </ul>
        <nav>
            <div class="nav-wrapper">
                <a href="#!" class="brand-logo">
                    <span v-if="currentDvr.key">{{ currentDvr.key }}</span>
                    <span v-else>
                        Stealth Monitoring DVR Viewer
                    </span>
                </a>
                <a href="#" data-activates="mobile-drop" class="button-collapse">
                    <i class="material-icons">menu</i>
                </a>

                <ul class="right hide-on-med-and-down">
                    <li style="padding-right:1em;">
                        <a class="dropdown-button" href="#!" data-activates="dropdown1" data-constrainwidth="false">
                            Property List
                            <i v-if="user" class="material-icons right">arrow_drop_down</i>
                        </a>
                    </li>
                    <li v-if="user" style="padding-right:1em;" v-on:click="logout()">
                        <a href="#!">
                            {{ user.firstName + " " + user.lastName}}
                            <i class="material-icons right">exit_to_app</i>
                        </a>
                    </li>

                </ul>
                <ul class="side-nav" id="mobile-drop">
                    <li v-for="item in dvrOptions">
                        <a v-on:click="setCurrentDvr(item)">{{ item.key }}</a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Login In Card -->
        <div v-if="!user" style="margin:150px" class="row">
            <div class="col s12 m3"></div>
            <div class="col s12 m6 center">
                <div class="card white darken-1">
                    <div class="card-content">
                        <span class="card-title">Welcome to GeoViewer</span>
                        <div class="row">
                            <div class="input-field col s12 m6">
                                <input id="username" type="text" class="validate" v-model="username">
                                <label for="username" data-error="wrong" data-success="right">Username</label>
                            </div>
                            <div class="input-field col s12 m6">
                                <input id="password" type="password" class="validate" v-model="password">
                                <label for="password" data-error="wrong" data-success="right">Password</label>
                            </div>
                        </div>
                    </div>
                    <div class="card-action">
                        <button class="btn" v-on:click="login()">Login!</button>
                    </div>
                </div>
            </div>
            <div class="col s12 m3"></div>
        </div>

        <div class="row" style="margin-top: 1em;" v-if="currentDvr.key">
            <!--Handle the paging-->
            <div class="col s6 center">
                <button class="btn" v-if="minCamera > 0" v-on:click="setPage(minCamera-4)">
                    Page {{ page - 1}}
                </button>
            </div>
            <div class="col s6 center">
                <button class="btn" v-if="minCamera < 32" v-on:click="setPage(minCamera+4)">
                    Page {{ page + 1 }}
                </button>
            </div>
        </div>
        <div class="row" v-if="currentDvr.key">
            <div class="col s12 l8" v-if="selectedCamera!=null">
                <!--Display the selected camera zoomed in-->
                <!--Remove on DVR or Page change-->
                <div class="card" v-on:click="setSelectedCamera(selectedCamera)" style="width: 90%; margin-left: 5%;">
                    <video-feed :camera-number='selectedCamera' :url="'http://' + currentDvr.value + '/mjpeg?cam=' + (selectedCamera) + '&IDKey=' + currentDvr.token"
                        v-if="!loading" inline-template>
                        <div class="card-image">
                            <img :src="url">
                            <span class="card-title">
                                Camera {{ cameraNumber }}
                            </span>
                        </div>
                    </video-feed>
                </div>
            </div>
            <div class="col" v-if="cam+minCamera!==selectedCamera" :class="{m6: cam+minCamera!==selectedCamera && selectedCamera==null,
                              s4: cam+minCamera!==selectedCamera && selectedCamera!=null,
                              l3: cam+minCamera!==selectedCamera && selectedCamera!=null}" v-for="cam in 4">
                <!--Display 4 Cameras per page-->
                <!--Update the source when the page is changed by binding url and cameraNumber-->
                <div class="card" v-on:click="setSelectedCamera(cam+minCamera)">
                    <video-feed :camera-number='cam + minCamera' :url="'http://' + currentDvr.value + '/mjpeg?cam=' + (cam+minCamera) + '&IDKey=' + currentDvr.token"
                        v-if="!loading" inline-template>
                        <div class="card-image">
                            <img :src="url">
                            <span class="card-title">
                                Camera {{ cameraNumber }}
                            </span>
                        </div>
                    </video-feed>
                </div>
            </div>
        </div>
    </div>

    <script>
        var urlBase = "https://zeus.stealthmonitoring.net/api-v1";
        var headers;
        Vue.component('video-feed', {
            props: {
                cameraNumber: Number,
                url: String
            },
            data: {
            },
            created() {
            },
            destroy() {
                this.url = '';
            },
            methods: {}
        });
        var dvrData = new Vue({
            el: '#app',
            data: {
                username: "",
                password: "",
                dvrOptions: [],
                ipToken: {},
                currentDvr: {},
                minCamera: 1,
                page: 1,
                loading: false,
                selectedCamera: null,
                user: null
            },
            methods: {
                login: function () {
                    if(this.username === "tomejia" ){
                        this.$http.post(urlBase + '/user-login', { "username": this.username, "password": this.password })
                            .then(function (response) {
                                this.user = response.body;
                                localStorage.setItem('user', JSON.stringify(this.user))
                                this.setToken(this.user.token)
                                this.dvrOptions = [
                                    {"key":"SBR_TXParkForestSW_1","value":"76.213.72.241"},
                                    {"key":"SEWL_TXGrapeBMW_2","value":"47.190.46.87"},
                                    {"key":"SEWL_TXGrapeCadillac_2","value":"50.84.142.69"}
                                    {"key":"FRSC_CityHall_1","value":"65.36.54.116"},
                                    {"key":"PECO_NVGreenValley_1","value":"70.187.116.104"},
                                    {"key":"AHG_TXArrowoodApts_1","value":"96.83.62.58"},
                                    {"key":"BXMR_CAUplandTownSq_1","value":"76.81.207.34"},
                                    {"key":"CHVZ_TXCasaSaldana_1","value":"98.6.222.10"},
                                    {"key":"CL_FLOrlandoKiaWest_1","value":"71.42.38.85"},

                                    {"key":"GDKE_TX1717McKinney_1","value":"216.201.155.78"},
                                    {"key":"GRNT_TXGP5_1","value":"216.201.223.149"},

                                    
                                ];
                            
                                $('select').material_select();
                                $('.modal').modal();
                                $(".button-collapse").sideNav();
                            }, function (error) {
                                Materialize.toast('Incorrect credentials', 5000);
                            })
                            
                            
                            
                    }else{
                        // Pull list of DVRs for the given user
                        this.$http.post(urlBase + '/user-login', { "username": this.username, "password": this.password })
                            .then(function (response) {
                                this.user = response.body;
                                localStorage.setItem('user', JSON.stringify(this.user))
                                this.setToken(this.user.token)
                                this.getDvrOptions();
                            }, function (error) {
                                Materialize.toast('Incorrect credentials', 5000);
                            })
                    }
                    
                    
                },
                logout: function () {
                    this.username = "";
                    this.password = "";
                    this.dvrOptions = [];
                    this.ipToken = {};
                    this.currentDvr = {};
                    this.minCamera = 1;
                    this.page = 1;
                    this.loading = false;
                    this.selectedCamera = null;
                    this.user = null;
                    localStorage.removeItem('user');
                },
                setToken: function (token) {
                    headers = { 'Authorization': 'Token ' + token };
                },
                getDvrOptions: function () {
                    // Pull list of DVRs for the given user
                    this.$http.get(urlBase + '/dvr/dvr-ip-search',
                        { headers: headers }).then(
                        function (response) {
                            this.dvrOptions = response.body.dvr_ips;
                            $('select').material_select();
                            $('.modal').modal();
                            $(".button-collapse").sideNav();
                        }, function (error) {
                            Materialize.toast('Unable to access Database', 5000);
                        })
                },
                setCurrentDvr: function (selectedDvr) {
                    // Get the currentDvr's token or clear currentDvr if unable to retrieve token
                    this.minCamera = 0;
                    this.page = 1;
                    this.currentDvr = selectedDvr;
                    this.selectedCamera = null;
                    this.loading = true;
                    this.$http.get(urlBase + '/dvr/get-gvtoken/' + this.currentDvr.value,
                        { headers: headers }).then(
                        function (response) {
                            this.currentDvr['token'] = response.body['key'];
                            this.loading = false;
                        }, function (error) {
                            this.currentDvr = {};
                            Materialize.toast('Unable to access property', 5000);
                        }
                        );
                },
                setPage: function (newCameraMin) {
                    this.selectedCamera = null;
                    if (newCameraMin > this.minCamera) {
                        this.page++;
                    } else {
                        this.page--;
                    }
                    this.minCamera = newCameraMin;
                },
                setSelectedCamera: function (selectedCamera) {
                    this.selectedCamera = this.selectedCamera !== selectedCamera ? selectedCamera : null;
                }
            }
        });
        // Start
        window.onload = function () {
            this.dvrData.user = JSON.parse(localStorage.getItem('user'));
            if (this.dvrData.user) {
                this.dvrData.setToken(this.dvrData.user.token);
                
                if(this.dvrData.user.username === "tomejia"){
                    this.dvrOptions = [
                        {"key":"FRSC_CityHall_1","value":"65.36.54.116"},
                        {"key":"PECO_NVGreenValley_1","value":"70.187.116.104"},
                        {"key":"AHG_TXArrowoodApts_1","value":"96.83.62.58"},
                        {"key":"BXMR_CAUplandTownSq_1","value":"76.81.207.34"},
                        {"key":"CHVZ_TXCasaSaldana_1","value":"98.6.222.10"},
                        {"key":"CL_FLOrlandoKiaWest_1","value":"71.42.38.85"},

                        {"key":"GDKE_TX1717McKinney_1","value":"216.201.155.78"},
                        {"key":"GRNT_TXGP5_1","value":"216.201.223.149"},

                        {"key":"SBR_TXParkForestSW_1","value":"76.213.72.241"},
                        {"key":"SEWL_TXGrapeBMW_2","value":"47.190.46.87"},
                        {"key":"SEWL_TXGrapeCadillac_2","value":"50.84.142.69"}
                    ];
                    $('select').material_select();
                    $('.modal').modal();
                    $(".button-collapse").sideNav();
                }else{
                    this.dvrData.getDvrOptions();
                }
                
            }
        };
    </script>
</body>

</html>
