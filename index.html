<html>
    <head>
        <!--Styling-->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

        <!-- JavaScript -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb"
            crossorigin="anonymous"></script>
        <!--Vue Stuff-->
        <script src="https://cdn.jsdelivr.net/npm/vue"></script>
        <script src="https://cdn.jsdelivr.net/npm/vue-resource@1.3.4"></script>

        <title>DVR Viewer</title>
    </head>

    <body>
        <div id="app">
            <ul id="dropdown1" class="dropdown-content">
                <li v-for="item in dvrOptions">
                    <a v-on:click="setCurrentDvr(item)">{{ item.key }}</a>
                </li>
            </ul>
            <nav>
                <div class="nav-wrapper">
                    <a href="#!" class="brand-logo">
                        <span v-if="currentDvr.key">{{ currentDvr.key }}</span>
                        <span v-else>
                            Stealth Monitoring DVR Viewer
                        </span>
                    </a>
                    <a href="#" data-activates="mobile-drop" class="button-collapse">
                        <i class="material-icons">menu</i>
                    </a>
                    <ul class="right hide-on-med-and-down">
                        <li style="padding-right:1em;">
                            <a class="dropdown-button" href="#!" data-activates="dropdown1" data-constrainwidth="false">
                                Property List
                                <i class="material-icons right">arrow_drop_down</i>
                            </a>
                        </li>
                    </ul>
                    <ul class="side-nav" id="mobile-drop">
                        <li v-for="item in dvrOptions">
                            <a v-on:click="setCurrentDvr(item)">{{ item.key }}</a>
                        </li>
                    </ul>
                </div>
            </nav>

            <div class="row" style="margin-top: 1em;" v-if="currentDvr.key">
                <!--Handle the paging-->
                <div class="col s6 center">
                    <button class="btn" v-if="minCamera > 0" v-on:click="setPage(minCamera-4)">
                        Page {{ page - 1}}
                    </button>
                </div>
                <div class="col s6 center">
                    <button class="btn" v-if="minCamera < 32" v-on:click="setPage(minCamera+4)">
                        Page {{ page + 1 }}
                    </button>
                </div>
            </div>
            <div class="row" v-if="currentDvr.key">
                <div class="col s12 m6 l6" v-for="cam in 4">
                    <!--Display 4 Cameras per page-->
                    <!--Update the source when the page is changed by binding url and cameraNumber-->
                    <div class="card">
                        <video-feed :camera-number='cam + minCamera' :url="'http://' + currentDvr.value + '/mjpeg?cam=' + (cam+minCamera) + '&IDKey=' + currentDvr.token"
                            v-if="!loading" inline-template>
                            <div class="card-image">
                                <img width="100%" :src="url">
                                <span class="card-title">Camera {{ cameraNumber }}</span>
                            </div>
                        </video-feed>
                    </div>
                </div>
            </div>
        </div>

        <script>
            var urlBase = 'https://zeus-test.stealthmonitoring.net/api-v1/dvr';
            var headers = { 'Authorization': 'Token 74f6300a349888019a841b543728a49a212d83a0' };
            Vue.component('video-feed', {
                props: {
                    cameraNumber: Number,
                    url: String
                },
                data: {
                },
                created() {
                },
                destroy() {
                    this.url = '';
                },
                methods: {}
            });


            var dvrData = new Vue({
                el: '#app',
                data: {
                    dvrOptions: [],
                    ipToken: {},
                    currentDvr: {},
                    minCamera: 1,
                    page: 1,
                    loading: false
                },
                methods: {
                    getDvrOptions: function () {
                        // Pull list of DVRs for the given user
                        this.$http.get(urlBase + '/dvr-ip-search',
                            { headers: headers }).then(
                            function (response) {
                                this.dvrOptions = response.body.dvr_ips;
                                $('select').material_select();
                                $(".button-collapse").sideNav();
                            }, function (error) {
                                Materialize.toast('Unable to access Database', 5000);
                            }
                            )

                    },
                    setCurrentDvr: function (selectedDvr) {
                        this.minCamera = 0;
                        this.currentDvr = selectedDvr;
                        this.setStreamInfo();
                    },
                    setStreamInfo: function () {
                        // Get the currentDvr's token or clear currentDvr if unable to retrieve token
                        this.loading = true;
                        this.$http.get(urlBase + '/get-gvtoken/' + this.currentDvr.value,
                            { headers: headers }).then(
                            function (response) {
                                this.currentDvr['token'] = response.body['key'];
                                this.loading = false;
                            }, function (error) {
                                this.currentDvr = {};
                                Materialize.toast('Unable to access property', 5000);
                            }
                            );
                    },
                    setPage: function (newCameraMin) {
                        if (newCameraMin > this.minCamera) {
                            this.page++;
                        } else {
                            this.page--;
                        }
                        this.minCamera = newCameraMin;
                    },
                    getCurrentIp: function () {
                        return this.currentDvr['value'];
                    },
                    getCurrentToken: function () {
                        return this.currentDvr.token;
                    }
                }
            });

            // Start
            window.onload = function () {
                this.dvrData.getDvrOptions();
            };
        </script>
    </body>

</html>